{"data":{"site":{"siteMetadata":{"title":"Mingjun Zhou's blog","author":"Mingjun Zhou","description":"personal blog"}}},"pageContext":{"posts":[{"internal":{"content":"\n# introduction\n- lvs:      \n  [lvs](http://www.linuxvirtualserver.org/) is a kind of L4 load balancer.              \n  some references here:\n  [howto] (http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/index.html)\n\n  \n- keepalived:       \n  [keepalived](http://www.keepalived.org/) is a facilitator for lvs\n\n# configuration\n\ntopology:\n\n- DIP: 192.168.2.172            \n- RIP[1]: 192.168.2.173         \n- RIP[2]: 192.168.2.174     \n- VIP: 192.168.2.175            \n\n## lvs only\ndirector side \n```\n#install ipvsadm\nyum -y install ipvsadm\necho 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf \nsysctl -p\ntouch /etc/sysconfig/ipvsadm \nsystemctl start ipvsadm \nsystemctl enable ipvsadm \n\n# add vip\nifconfig em1:0 192.168.2.175 netmask 255.255.255.255\n\n# configuration\nipvsadm -C\nipvsadm -A -t 192.168.2,175:80 -s rr\nipvsadm -a -t 192.168.2,175:80 -r 192.168.2,173:80 -g\nipvsadm -a -t 192.168.2,175:80 -r 192.168.2,174:80 -g\nipvsadm -l \n```\n\nrealserver side\n```\n# add vip\nifconfig lo:0 192.168.2.175 netmask 255.255.255.255 broadcast 192.168.2.175 \n\n# disable VIP arp\necho \"1\" > /proc/sys/net/ipv4/conf/lo/arp_ignore\necho \"2\" > /proc/sys/net/ipv4/conf/lo/arp_announce\necho \"1\" > /proc/sys/net/ipv4/conf/all/arp_ignore\necho \"2\" > /proc/sys/net/ipv4/conf/all/arp_announce\n```\n\n## lvs + keepalived\ndirector side \n\n```\nglobal_defs {              \n    router_id LVS_MASTER   \n}\nvrrp_instance VI_1 {       \n    state MASTER           \n    interface em1          \n    virtual_router_id 51   \n    priority 100           \n    advert_int 1           \n    authentication {       \n    auth_type PASS\n    auth_pass 1111\n    }\nvirtual_ipaddress {        \n    192.168.2.175\n    }\n}\nvirtual_server 192.168.2.175 80 {\n    delay_loop 6            \n    lb_algo wrr             \n    lb_kind DR              \n    nat_mask 255.255.255.0  \n    #persistence_timeout 5  \n    protocol TCP            \n    real_server 192.168.2.173 80 {      \n        weight 3                   \n        TCP_CHECK {               \n        connect_timeout 5        \n        nb_get_retry 3\n        delay_before_retry 3\n        connect_port 80\n        }\n    }\n    real_server 192.168.2.174 80 {\n        weight 3\n        TCP_CHECK {\n        connect_timeout 10\n        nb_get_retry 3\n        delay_before_retry 3\n        connect_port 80\n        }\n    }\n}\n```\n\nrealserver side\n```\n# add vip\nifconfig lo:0 192.168.2.175 netmask 255.255.255.255 broadcast 192.168.2.175 \n\n# disable VIP arp\necho \"1\" > /proc/sys/net/ipv4/conf/lo/arp_ignore\necho \"2\" > /proc/sys/net/ipv4/conf/lo/arp_announce\necho \"1\" > /proc/sys/net/ipv4/conf/all/arp_ignore\necho \"2\" > /proc/sys/net/ipv4/conf/all/arp_announce\n```"},"fields":{"slug":"/post/2017-03-22-lvs-keepalived/","category":"post"},"frontmatter":{"title":"lvs keepalived","date":"2017-03-22T17:23:36+08:00","tags":"devops"}}],"tag":"v","pagesSum":1,"page":0}}